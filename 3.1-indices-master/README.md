# Данные и индексы

## Описание

В одной фруктовой компании стали случаться сбои и часто происходило падение сервиса. При разборе инцидентов выяснилось, что в какой-то момент СУБД загружается на 100% и увеличивается время ответа. 

Проблема оказалась в долгом выполнение запросов поиска пользователей.

Помогите настроить индексы в базе данных так, чтобы эти запросы выполнялись быстрее.

## Запуск проекта

Чтобы разобраться в том как работает сервис первым делом необходимо его локально запустить.

Для этого понадобятся:

- [Docker](https://docs.docker.com/manuals/) для запуска контейнеров
  - Если вы не знаете что это такое, то стоит прочитать короткий [ликбез](https://sam-ngu.medium.com/docker-tutorial-getting-started-80775e93d4d)
  - Описания уже готовых контейнеров лежат в файле `docker-compose.yml`
- [Make](https://www.gnu.org/software/make/manual/make.html)
  - Если вы не знаете что это такое, то стоит прочитать короткий [ликбез](https://swarnakar-ani24.medium.com/a-noobs-guide-to-using-make-and-writing-makefile-f718135d816b)
  - Описания уже готовых команд находятся в файле `Makefile`

Проект состоит из трех контейнеров:

- store - база данных
- service - сервис поиска данных

Чтобы запустить проект выполните шаги:

1. Соберите образ сервиса командой `make build`

2. Запустите контейнеры командой `make up`
   - После запуска будет выполнен health-check, если он не проходит то нужно разобраться в чем проблема (по [логам](#просмотр-логов)) и устранить её
  
3. Проверьте что все три контейнер запущены и работают командой `make status`

### Выполнение запросов

Чтобы проэмулировать реальное взаимодействия пользователя с сервисом можно выполнить какие-нибудь запросы:

- Поиск пользователей: `curl "localhost:8000/v1/users/?search=Nəzirova"`

- Поиск пользователей по расширенному набору полей и сортировкой: `curl "localhost:8000/v2/users/?search=874"`

Вы можете найти тексты выполняющихся запросов и время их выполнения в [логах](#просмотр-логов).

### Просмотр логов

Если вы используете Docker Desktop, то прямо в нём можно удобно смотреть логи и выполнять команды внутри контейнеров.

Также это можно сделать командой `make logs`.

## Подключение к базе

Дополнительно можно подключиться к базе, чтобы смотреть таблицы, их схемы и выполнять запросы.

Например, это можно сделать при помощи плагина [PostgreSQL](https://marketplace.visualstudio.com/items?itemName=ckolkman.vscode-postgres) к vscode.

Данные для подключения:
    - host: `127.0.0.1`
    - port: `5432`
    - user: `user`
    - password: `random`

Альтернативный вариант - консольная утилита `psql`.  Для входа в интерактивный режим выполните команду `make psql`. Подробнее о работе с `psql` - [документация](https://www.postgresql.org/docs/current/app-psql.htm).

## Оптимизация запросов

Контейнер service пишет в [логи](#просмотр-логов), какие SQL запросы выполняет - именно эти запросы нужно соптимизировать, добавив индексы. Для анализа этих запросов, [подключитесь к базе](#подключение-к-базе) любым способ и используйте SQL команду [EXPLAIN ANALYZE](https://www.postgresql.org/docs/current/sql-explain.html). Эта команда показывает сколько времени на какие операции тратит база в процессе выполнения запроса.

## Описание заданий

**Цель:**

Научиться анализировать и оптимизировать SQL-запросы для повышения их эффективности и уменьшения нагрузки на базу данных.

### Задание-1: Ускорение поиска

Научиться анализировать и оптимизировать SQL-запросы для повышения их эффективности и уменьшения нагрузки на базу данных.

**Описание задания:**

У вас есть следующий SQL-запрос, который извлекает данные из таблицы `users_user`. Ваша задача проанализировать этот запрос, выявить его слабые места и предложить способы оптимизации.

```sql
SELECT 
    "users_user"."id", 
    "users_user"."first_name", 
    "users_user"."second_name", 
    "users_user"."last_name", 
    "users_user"."email", 
    "users_user"."address", 
    "users_user"."phone_number", 
    "users_user"."company_id", 
    "users_user"."job_id" 
FROM 
    "users_user" 
WHERE 
    UPPER("users_user"."first_name"::text) LIKE UPPER('John%') 
    OR UPPER("users_user"."last_name"::text) LIKE UPPER('John%'));
```

**Задача:**

1. **Анализ запроса:**
   - Объясните, какие данные извлекает данный запрос и какие условия фильтрации применяются.
   - Определите потенциальные проблемы с производительностью данного запроса.

2. **Оптимизация запроса:**
   - Предложите возможные индексы для ускорения выполнения данного запроса.

3. **Тестирование производительности:**
   - Сравните производительность запросов с различными индексами.


### Задание-2: Ускорение поиска

**Описание задания:**

У вас есть следующий SQL-запрос, который извлекает данные из таблицы `users_user`. Ваша задача проанализировать этот запрос, выявить его слабые места и предложить способы оптимизации.

```sql
SELECT 
    "users_user"."id", 
    "users_user"."first_name", 
    "users_user"."second_name", 
    "users_user"."last_name", 
    "users_user"."email", 
    "users_user"."address", 
    "users_user"."phone_number", 
    "users_user"."company_id", 
    "users_user"."job_id" 
FROM 
    "users_user" 
WHERE 
    (
        UPPER("users_user"."first_name"::text) LIKE UPPER('%John%') 
        OR UPPER("users_user"."last_name"::text) LIKE UPPER('%John%') 
        OR UPPER("users_user"."phone_number"::text) LIKE UPPER('John%') 
        OR UPPER("users_user"."email"::text) LIKE UPPER('%John%')
    ) 
ORDER BY 
    "users_user"."last_name" ASC;
```

**Задача:**

1. **Анализ запроса:**
   - Объясните, какие данные извлекает данный запрос и какие условия фильтрации применяются.
   - Определите потенциальные проблемы с производительностью данного запроса.
   - Найдите отличие от задания-1.

2. **Оптимизация запроса:**
   - Предложите возможные индексы для ускорения выполнения данного запроса.

3. **Тестирование производительности:**
   - Сравните производительность запросов с различными индексами.

### Задание-3: Ускорение поиска

**Описание задания:**

У вас есть следующий SQL-запрос, который извлекает данные из таблицы `orders`. Ваша задача проанализировать этот запрос, выявить его слабые места и предложить способы оптимизации индексов.

```sql
SELECT
    order_id,
    customer_id,
    order_date,
    total_amount,
    status,
    shipping_address,
    billing_address
FROM
    orders
WHERE
    status = 'Pending'
ORDER BY
    order_date;
```

**Задача:**

1. **Анализ запроса:**
   - Объясните, какие данные извлекает данный запрос и какие условия фильтрации применяются.
   - Определите потенциальные проблемы с производительностью данного запроса.

2. **Оптимизация запроса:**
   - Предложите возможные индексы для ускорения выполнения данного запроса.

3. **Тестирование производительности:**
   - Сравните производительность запросов с различными индексами.

**Подсказки:**

- Обратите внимание на использование индексов для условий фильтрации и сортировки.
- Составные индексы могут быть полезны, если запрос использует несколько столбцов в условиях фильтрации и сортировки.
- Убедитесь, что новые индексы не создадут значительных накладных расходов на вставку и обновление данных в таблице.


### Дополнительные материалы:

- Документация PostgreSQL по индексам: https://www.postgresql.org/docs/current/indexes.html


## Как сдать домашку 

Нужно описать недостающие индексы:

- tasks/task_v1.sql - для оптимизации запросов `/v1/users/?search=...`;
- tasks/task_v2.sql - для оптимизации запросов  `/v2/users/?search=...`;
- tasks/task_v3_orders.sql - для оптимизации запросов  `/pending_orders`;

Индексы нужно исправлять в контейнере store и дублировать в файле `tasks/task_v[1|2|*].sql`. Нужно убедиться, что при применении индексы не падают.

## Автотесты

Для запуска автотестов нужно обновиться из базового репозитория и сделать коммит.

Методика проверки:

1. Будут применены SQL скрипты в файлах `tasks/task_v1.sql`, `tasks/task_v2.sql`, `tasks/task_v3_orders.sql` и сделаны замеры производительности

**TODO:** для запуска использовать `make test` ?
